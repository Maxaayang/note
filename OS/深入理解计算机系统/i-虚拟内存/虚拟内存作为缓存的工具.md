### 虚拟内存作为缓存的工具
磁盘（较低层）上的数据被分割成块，这些块作为磁盘和主存（较高层）之间的传输单元。
**虚拟页（VP）**：VM 系统将虚拟内存分割成虚拟页大小的固定的块。
每个虚拟页的大小为 P=2<sup>p</sup> 字节。
**物理页**：物理内存被分割为物理页，大小也为 P 字节（物理页也称为页帧）

虚拟页的分类：
* 未分配的：VM 系统还未分配（或者创建）的页。未分配的块没有任何数据和它们相关联，因此也就不占用任何磁盘空间。
* 缓存的：当前已缓存在物理内存中的已分配页。
* 未缓存的：未缓存在物理内存中的已分配页。

#### DRAM缓存的组织结构
SRAM 缓存表示位于 CPU 和主存之间的 L1、L2 和 L3 高速缓存。
DRAM 缓存表示虚拟内存系统的缓存，它在主存中缓存虚拟页。

DRAM 缓存是全相联的，即任何虚拟页都可以放置在任何物理页中。
因为对磁盘的访问时间很长，DRAM 缓存总是使用写回，而不是直写。

#### 页表
页表：存放在物理内存中，负责将虚拟页映射到物理页。是一个页表条目 (PTE) 的数组。
每个 PTE 由一个有效位和一个 n 位地址字段组成。有效位表明该虚拟页当前是否被缓存在 DRAM 中。
如果*设置了有效位*，地址字段就表示 DRAM 中相应的物理页的起始位置，这个物理页中缓存了该虚拟页。
如果*没有设置有效位*，那么一个空地址表示这个虚拟页还没有被分配。否则，这个地址就指向该虚拟页在磁盘上的起始位置。

![image.png](https://s2.loli.net/2021/12/19/gNUiq6olOLyBwQS.png)
该系统的页表有八个虚拟页和四个物理页。
其中四个虚拟页被缓存在 DRAM 中，两个页还未被分配，剩下的页已经被分配了，但是当前还未被缓存。

#### 缺页
DRAM 缓存不命中称为缺页。
缺页异常处理程序：选择一个牺牲页，将未缓存的页复制到这里。

在磁盘和内存之间传送页的活动叫做交换或页面调度。
按需页面调度：当有不命中发生时，才换入页面。

#### 分配页面
![image.png](https://s2.loli.net/2021/12/19/lEi4mRzaMBhTs1v.png)

VP5 的分配过程是在磁盘上创建空间并更新 PTE5，使它指向磁盘上这个新创建的页面。

#### 局部性
局部性原则：在任意时刻，程序将趋向于在一个较小的活动页面集合上工作，这个集合叫做工作集或常驻集合。
在初始开销，即将工作集调度到内存中之后，接下来对这个工作集的引用将导致命中，而不会产生额外的磁盘流量。

抖动：因为工作集的大小超出了物理内存的大小，页面不断地换进换出。
























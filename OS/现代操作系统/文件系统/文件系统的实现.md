#### 文件系统布局
主引导扇区（Master Boot Record, MBR）：磁盘的 0 号扇区。
在 MBR 的结尾是==分区表==，该表给出了每个分区的起始和结束地址，表中的一个分区被标记为活动分区。
在计算机被引导时，BIOS 读入并执行 MBR，MBR 首先读入==引导块==并执行，引导块的程序将装载该分区的操作系统。
每个分区都从一个引导块开始，即使它不含有一个可启动的操作系统。

![mBtCl2AKM6JGLHc](https://s2.loli.net/2021/12/30/mBtCl2AKM6JGLHc.png)

超级块（superblock）：包含文件系统的所有关键参数，在计算机启动时，或者在该文件系统首次使用时，超级块会被读入内存。

#### 文件的实现
1. 连续分配
![OZtNfMwUJj2RIL3](https://s2.loli.net/2021/12/30/OZtNfMwUJj2RIL3.png)
**优势：**
* 实现简单，记录每个文件用到的磁盘块简化为只需记住==第一块的磁盘地址==和==文件块数==。
* 读操作性能较好，单个操作中就可以从磁盘上读出整个文件

**缺点**：随着时间的推移，磁盘会变得零碎。
**措施：**
* 压缩磁盘，代价太大不可行。
* 维护一个空洞列表。

2. 链表分配
![62rgjft3IAzRa8l](https://s2.loli.net/2021/12/30/62rgjft3IAzRa8l.png)
在目录项中，只需要存放第一块的磁盘地址，文件的其他块就可以从这个首块地址查找到。
**缺点：**
* 随机访问速度非常慢。
* 许多的程序都是以长度为 2 的整数次幂来读写磁盘块，由于每个块的前几个字节被指向下一个块的指针所占据，所以每个磁盘块存储数据的字节数不再是 2 的整数次幂，从而要读出完整的一个块大小的信息，就需要从两个磁盘块中获得和拼接信息，从而因为复制引发了额外的开销。

3. 采用内存中的表进行链表分配
![XYV7AuqCwkOo6Tf](https://s2.loli.net/2021/12/30/XYV7AuqCwkOo6Tf.png)
文件分配表（File Allocation Table，FAT）：取出每个磁盘块的指针字，把它们放在内存的一个表中。
每个链以一个不属于有效磁盘编号的特殊标记（如 -1）结束。
**缺点**：必须把整个表都存放在内存中，不能较好地扩展并应用于大型磁盘中。

4. i 节点
![sylF58J7VIkxWXp](https://s2.loli.net/2021/12/30/sylF58J7VIkxWXp.png)
为每个文件赋予一个==i节点==，其中累出了文件属性和文件块的磁盘地址。
**问题**：如果每个 i 节点只能存储固定数量的磁盘地址，当一个文件所含的磁盘块的数目超出了 i 节点所能容纳的数目怎么办？
* 最后一个“磁盘地址”不指向数据块，而是指向一个包含额外地址的块的地址。
* 有两个或更多个包含磁盘地址的块，或者指向其他存放地址的磁盘块的磁盘块。

#### 目录的实现
在何处存放文件属性：
* 把文件属性直接存放在目录项中。
* 把文件属性存放在 i 节点中。

对于可变长度的长文件名如何存放目录项
1. 每个目录项有一个固定的部分，通常以目录项的长度开始，后面是固定格式的数据，通常包括所有者、创建时间、保护信息以及其他属性，后面是一个任意长度的文件名。
**缺点：**
* 当文件移走之后，便引入了一个长度可变的空隙，而下一个进来的文件不一定正好适合这个空隙。
* 一个目录项可能会分不在多个页面上，在读取文件名时可能发生缺页中断。

2. 使目录项自身都有固定的长度，而将文件名放置在目录后面的堆中。
**优点：**
* 当一个文件目录被移走后，另一个目录项总是可以适合这个空隙。
* 文件名不再需要从字的边界开始。
**缺点：** 在处理文件名时缺页中断仍旧会发生。

**散列表**
![j34tEofb2sHqkRG](https://s2.loli.net/2021/12/30/j34tEofb2sHqkRG.png)
如何加速文件名的查找：在每个目录中使用==散列表==。
==添加一个文件==时，对与散列值相对应的散列表表项进行检查
* 如果该表项没有被使用，就将一个指向文件目录项的指针放入，文件目录项紧连在散列表后面。
* 如果该表项被使用了，就构造一个链表，该链表的表头存放在该表项中，并链接所有具有相同散列值的文件目录项。
==查找一个文件==，散列处理文件名，以便选择一个散列表项，检查链表头在该位置上的链表的所有表项，查看要找的文件名是否存在，如果名字不再该链上，该文件就不在这个目录中。
使用散列表的==优点==是查找非常迅速，==缺点==是需要复杂的管理。

#### 共享文件
![aEfYCriqH5wZnBI](https://s2.loli.net/2021/12/30/aEfYCriqH5wZnBI.png)
**问题**：如果目录中包含磁盘地址，则当链接文件时，必须把 C 目录中的磁盘地址复制到 B 目录中。如果 B 或 C 随后又往该文件中添加内容，则新的数据块姜只列入进行添加工作的用户的目录中，其他的用户对此改变是不知道的，从而==违背了共享的目的==。
**措施：**
1. 磁盘不列入目录，而是列入一个与文件本身关联的小型数据结构中，目录指向这个小型数据结构。
**缺点**：建立一个链接并不改变所有关系，但将 i 节点的链接计数加 1。如果文件所属者删除这个文件，将出现问题。

2. 符号链接：让系统建立一个类型为 LINK 的新文件，并把该文件放在 B 的目录下，使得 B 与 C 的一个文件存在连接。新的文件中只包含了它所连接的文件的路径名。当 B 读该连接文件时，操作系统査看到要读的文件是 LINK 类型，则找到该文件所连接的文件的名字，并且去读那个文件。
只有真正的文件所有者才有一个指向 i 节点的指针，==链接到该文件上的用户只有路径名==，当文件所有者删除文件时，该文件被销毁，以后若试图通过符号链接访问该文件将导致失败，因为系统不能找到该文件。
**优点**：只要简单地提供一个机器的网络地址以及文件在该机器上驻留的路径，就可以链接全球任何地方的机器上的文件。
**缺点：**
* 必须读取包含路径的文件，然后要一个部分一个部分地扫描路径，直到找到 i 节点，可能会导致很多次额外的磁盘访问。
* 每个符号链接都需要额外的 i 节点，以及额外的一个磁盘用于存储路径。
* 如果允许链接，文件有两个或多个路径，查找一指定目录及其子目录下的全部文件的程序将多次定位到被链接的文件。

#### 日志结构文件系统













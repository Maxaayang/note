#### 局部分配策略与全局分配策略
局部算法：可以有效地为每个进程分配固定的内存片段。
全局算法：在可运行进程之间动态地分配页框。

**局部算法的缺点**：即使有大量的空闲页框存在，工作集的增长也会导致颠簸；如果工作集缩小了，又会浪费内存。

使用全局算法时如何确定给每个进程分配多少页框？
1. 监测工作集的大小
工作集的大小由“老化”位指出，但这个方法并不能防止颠簸，因为工作集的大小可能在几微秒内就会发生改变，而老化位却要经历一定的时钟滴答数才会发生改变。

2. 使用一个为进程分配页框的算法
* 定期确定进程运行的数目并为它们分配相等的份额。
* 按照进程大小的比例为它们分配相应数目的页面。
* 对每个进程都规定一个最小的页框数。

在全局算法中，可以使用 PFF（Page Fault Frequency，缺页中断率）算法来管理动态内存分配，它指出了何时增加或减少分配给一个进程的页面，但却没有说明在发生缺页时应该替换掉哪一个页面，仅仅控制分配集的大小。

#### 页面大小
页面较大时会产生[[动态内存分配#^3475fe|内部碎片]]

小页面意味着程序需要更多的页面，从而需要更大的页表。
内存于磁盘之间的传输一般是一次一页，如果页面太小的话，传输中的大部分时间都花在了寻道和旋转延迟上来。
小页面可以更充分地利用 TLB 空间。

在条件允许的情况下应该使用大页面，因为 TLB 表项相对比较稀缺，并且对性能是至关重要的。

#### 分离的指令空间和数据空间
![image.png](https://s2.loli.net/2021/12/28/XI35wD9lzApgOom.png)

指令和数据设置分离的地址空间，分别称为 I 空间和 D 空间。
两种地址空间都可以进行分页，而且相互独立，它们分别有自己的页表，分别完成虚拟页面到物理页框的映射。
拥有独立的 I 空间和 D 空间不会引入任何复杂的设计，而且它还能使**可用的地址空间加倍。**

#### 共享页面
并不是所有的页面都适合共享，只读的页面可以共享，但是数据页面不能共享。
每个进程在它的进程表中都有两个指针：一个指向 I 空间页表，一个指向 D 空间页表。

在一个进程结束后，如何发现页面仍在被使用？

在 UNIX 中，执行`fork`之后，父进程与子进程共享文本和数据，且为[[内存映射#^d312da|写时复制]]。

#### 共享库
未定义外部函数：在目标文件中调用了但是没有被定义的函数。
任何被未定义外部函数调用了但是不存在的函数也会成为未定义函数。

引入共享库的原因：静态链接上百个包括这些库的程序会浪费大量的磁盘空间，在装载这些程序时也会浪费大量的内存空间。

当一个程序和共享库链接时，链接器没有加载被调用的函数，而是加载了一段能够在运行时绑定被调用函数的存根例程，依赖于系统和配置信息，共享库或者和程序一起被装载，或者在其所包含函数第一次被调用时被装载。

当一个共享库被装载和使用时，整个库并不是被一次性地读入内存，而是根据需要，以页面为单位装载的，因此没有被调用到的函数是不会被装载到内存中的。

**共享库的优点**
* 使可执行文件更小，节省内存空间。
* 如果共享库中的一个函数因为修正一个 bug 被更新了，那么并不需要重新编译调用了这个函数的程序，旧的二进制文件依然可以正常工作。

**共享库的问题**
共享库是共享的，在装载时再进行重定位行不通。
如何解决？
* 写时复制，并为每一个共享这个库的进程创建新页面，在创建新页面的过程中进程重定位，==但是这与共享库的目的相悖==。
* 在编译共享库时，用一个特殊的编译选项告知编译器，不要产生使用绝对地址的指令，只能产生使用相对地址的指令。

#### 内存映射文件
基本思想：进程可以通过发起一个系统调用，将一个文件映射到其虚拟地址空间的一部分。

在多数实现中，在映射共享的页面时不会实际读入页面的内容，而是在访问页面时才会被每次一页地读入，磁盘文件则被当作后备存储。当进程退出或显式地解除文件映射时，所有被改动的页面会被写回到磁盘文件中。

内存映射文件提供了一种 I/O 的可选模型，可以把一个文件当做一个内存中的大字符数组来访问，而不用通过读写操作来访问这个文件。

如果两个或两个以上的进程同时映射了同一个文件，它们就可以通过==共享内存==来通信。一个进程在共享内存上完成了写操作，此刻当另一个进程在映射到这个文件的虚拟地址空间上执行读操作时，就可以立刻看到上一个进程写操作的结果。

#### 清除策略
分页守护进程：定期被唤醒检查内存的状态，如果空闲页框过少，就会通过预定的页面置换算法选择页面换出内存。

**实现方法**：双指针时钟
==前指针==由分页守护进程控制，当它指向一个脏页面时，就把该页面写回磁盘，前指针向前移动，当它指向一个干净页面时，仅仅指针向前移动。==后指针==用于页面置换。

#### 虚拟内存接口
共享内存：通过让一个进程把一片内存区域的名称通知另一个进程，而使得第二个进程可以把这片区域映射到它的虚拟地址空间去。==前提是==程序员可以对内存区域进行命名。








## 应用层

套接字：同一台主机内应用层与运输层之间的接口（应用程序和网络之间的应用程序编程接口）

开发者：选择运输层协议、设定几个运输层参数

为了标识接收进程，需要主机的地址与在目的主机中指定接收进程的标识符

运输层提供的服务：可靠数据传输、吞吐量、定时、安全性

**TCP服务：**TCP服务模型包括*面向连接服务*和*可靠数据传输服务*，还具有*拥塞控制机制*

**UDP服务：**不提供不必要服务的轻量级运输协议，仅提供最小服务（无连接的，没有握手过程）

* UDP协议不保证报文到达接收进程
* 到达接收进程的报文可能是乱序到达

面向连接的服务：在应用层数据报文开始流动之前，TCP让客户和服务器互相交换运输层控制信息，在两个进程的套接字之间建立一个TCP连接，并且为全双工，在结束报文发送时，必须拆除该连接。



**今天的英特网通常能够为时间敏感应用提供满意的服务，但它不能提供任何定时或带宽保证。**



应用层协议定义了：

* 交换的报文类型
* 各种报文类型的语法
* 字段的语义
* 确定一个进程何时以及如何发送报文，对报文进行响应的规则



### HTTP 协议

HTTP实现：客户程序、服务器程序

Web页面由对象组成，多数Web页面含有一个HTML基本文件和几个引用对象，HTML基本文件通过对象的URL地址引用页面中的其他对象。

URL地址的组成：存放对象的服务器主机名、对象的路径名。

HTTP实用TCP作为支撑运输协议。

HTTP服务器不存储关于客户的任何信息，是一个**无状态协议**。



非持续连接：每个请求/响应通过一个单独的TCP连接发送（每个TCP连接只传输一个请求报文和一个响应报文）。

**三次握手：**

* 客户向服务器发送一个小的TCP片段
* 服务器用一个小的TCP片段做出确认和响应
* 客户向服务器返回确认（客户结合第三次握手向该TCP连接发送一个HTTP请求报文）

**缺点**

* 必须为每个请求对象建立和维护一个全新的连接，每个连接在客户和服务器中都要分配TCP的缓冲区和保持TCP变量，给Web服务器带来了严重的负担。
* 每一个对象经受两倍的交付时延，一个RTT用于创建TCP，另一个RTT用于请求和接收一个对象。



持续连接：所有的请求及其响应经相同的TCP连接发送。



HTTP报文：请求报文、响应报文

```
//HTTP请求报文
GET /somedir/page.html HTTP/1.1		//请求行（方法字段（GET（绝大部分）、POST、HEAD、PUT、DELETE）、URL字段、HTTP版本字段）
Host: www.someschool.edu		//首部行，提供的信息为Web高速缓存所要求的
Connection: close		//非持续连接
User-agent: Mozilla/5.0		//用户代理（向服务器发送请求的浏览器类型），服务器为不同的用户代理发送相同对象的不同版本
Accept-laguage: fr	

//当用户提交表单时，HTTP客户常常使用POST方法，HTML表单经常使用GET方法
//当服务器收到一个使用HEAD方法的请求时，将会用一个HTTP报文进行响应，但是并不返回请求对象
//PUT方法常与Web发行工具联合使用，允许用户上传对象到指定的Web服务器上的指定路径
//PUT方法也常被那些需要向Web服务器上传对象的应用程序使用
//DELETE方法允许用户或者应用程序删除Web服务器上的对象

//HTTP响应报文
//初始状态行、6个首部行、实体体
HTTP/1.1 200 OK		//协议版本字段、状态码、相应状态信息
Connection: close		//发送完报文后关闭该TCP连接
Date: Tue, 18 Aug 2015 15:44:04 GMT		//服务器从文件系统检索到该对象，并将该对象插入响应报文，发送该报文的时间
Server: Apache/2.2.3 (CentOS)		//该报文由一台 Apache Web 服务器产生
Last-Modified: Tue, 18 Aug 2015 15:11:03 GMT	//该对象创建或者最后修改的日期（对既可能在本地客户也可能在网络缓存服务器上的对																								象非常重要）
Content-Length: 6821	//被发送对象的字节数
Content-Type: text/html		//指示了实体体中的对象是HTML文本
(data data data data data ...)
```

**一些常见的状态码及相关的短语**

* 200 OK：请求成功，信息在反悔的报文中。
* 301 Moved Permanently：请求的对象已经被永久转移了，新的 URL 定义在响应报文的 Location：首部行中。客户软件将自动获取新的 URL。
* 400 Bad Request：一个通用差错代码，指示该请求不能被服务器理解。
* 404 Not Found：被请求的文档不在服务器上。
* 505 HTTP Version Not Supported：服务器不支持请求报文使用的 HTTP 协议版本。



**cookie：**因为 HTTP 协议是无状态的，所以出现了 cookie，它允许站点对用户进行跟踪。

cookie 的四个组件：

* 在 HTTP 响应报文中的一个 cookie 首部行
* 在 HTTP 请求报文中的一个 cookie 首部行
* 在用户端系统中保留一个 cookie 文件，并由用户的浏览器进行管理
* 位于 Web 站点的一个后端数据库



Web 缓存器（代理服务器）：可以代表初始 Web 服务器满足 HTTP 请求的网络实体，拥有自己的磁盘存储空间，并在存储空间中保存最近请求过的对象的副本。

Web 缓存器既是服务器又是客户。

部署 Web 缓存器的原因：

* 可以大大减少对客户请求的响应时间，特别是当客户与初始服务器之间的瓶颈带宽远低于客户与 Web 缓存器之间的瓶颈带宽时。
* 大大减少一个机构的接入链路到因特网的通信量，通过减少通信量，机构就不必急于增加带宽，从而降低的成本。
* 可以从整体上大大减低因特网上的 Web 流量，从而改善了所有应用的性能。

**问题：**存放在缓存器中的对象副本可能是陈旧的。

条件 Get：允许缓存器证实它的对象是最新的。

* 请求报文使用 Get 方法。
* 请求报文包含一个“If- Modified- Since：”首部行

```
//缓存器请求报文
Get /fruit/kiwi.gif HTTP/1.1
Host: www.exotiquecuisine.com
If-modified-since: Web, 9 Sep 2015 09:23:24

//Web服务器响应报文
HTTP/1.1 304 Not Modified
Date: Sat, 10 Oct 2015 15:39:29
Server: Apache/1.3.0 (Unix)
(empty entity body)
```





### 电子邮件

电子邮件系统的主要组成部分：用户代理（user agent）、邮件服务器（mail server）、简单邮件传输协议（Simple Mail Transfer Protocol，SMTP）

用户代理：允许用户阅读、回复、转发、保存和撰写报文（Outlook）。



发送方的用户代理 -> 发送方的邮件服务器 -> 接收方的邮件服务器 -> 接收方的邮箱



发送方的邮件服务器必须可以处理接收方的邮件服务器的故障。如果发送方的邮件服务器不能将邮件交付给接收方的邮件服务器，发送方的邮件服务器在一个**报文队列**中保持该报文并在以后尝试再次发送（一般为30min一次），如果几天之后仍不成功，服务器就删除该报文，并以电子邮件的方式通知发送方。

STMP 为英特网电子邮件中主要的应用协议：使用 TCP 可靠传输服务。

SMTP 包括两个部分：

* 运行在发送方邮件服务器的客户端
* 运行在接收方邮件服务器的服务端



**SMTP 一般不使用中间邮件服务器发送邮件**

按照 ASCII 码的表示方法，每个报文以 CRLF. CRLF 结束，其中 CR 和 LF 分别表示回车和换行。



**HTTP 与 SMTP 的对比**

* HTTP 主要是一个**拉协议**，即在方便的时候，某些人在服务器上装载信息，用户使用 HTTP 从该服务器拉取这些信息，特别是 TCP 连接是由想接收文件的服务器发起的。
* SMTP 是一个**推协议**，即发送邮件服务器把文件推向接收邮件服务器，特别是这个 TCP 连接是由要发送文件的服务器发起的。
* SMTP 要求每个报文（包括它们的体）采用 7 比特 ASCII 码格式，HTTP 数据不受这种限制。
* 如何处理既包含文本又包含图形的文档。HTTP 把每个对象封装到自己的响应报文中，SMTP 把所有的报文对象放在一个报文之中。



**邮件报文的格式**

首部行和该报文的体用空行（回车换行）进行分隔。

每个首部行包含了可读的文本，由**关键词**后跟**冒号**及其**值**组成。

每个首部必须包含一个 From：首部行和一个 To：首部行；一个首部也许包含一个 Subject：首部行以及其他可选的首部行。

```
//典型的报文首部（邮件报文自身的一部分）
From: alice@crepes.fr
To: bob@hamburger.edu
Subject: Searching for the meaning of life.
```



**如何解决接收方的用户代理不能使用 SMTP 得到报文？（取报文为一个拉操作，而 SMTP 协议是一个推协议）**

* 第三版的邮局协议（Post Office Protocol—Version 3，POP3）
* 英特网邮件访问协议（Internet Mail Access Protocol，IMAP）
* HTTP



**POP3**

在用户代理打开了一个到邮件服务器端口 110 上的 TCP 连接后，POP3 就开始工作了。

* 特许（authorization）：用户代理发送（以明文形式）用户名和口令以鉴别用户
* 事务处理：用户代理取回报文，还可以对报文做删除标记、取消报文删除标记、获取邮件的统计信息
* 更新：出现在客户发出 quit 命令之后，目的是结束该 POP3 会话，邮件服务器删除那些被标记为删除的报文



服务器的回答：

* +OK（有时后面还跟有服务器到客户的数据），被服务器用来指示前面的命令是正常的
* —ERR ，被服务器用来指示前面的命令出现了某些差错



特许阶段两个主要命令：user < user name >、pass < password >

用户可以配置 POP3 代理为：下载并删除（list、retr、dele、quit）、下载并保留



在用户代理与邮件服务器之间的 POP3 会话期间，该 POP3 服务器保留了一些状态信息，特别是记录了哪些用户报文被标记为删除了，但是 POP3 服务器并不在 POP3 会话过程中携带状态信息。



**IMAP**

POP3 协议没有给用户提供任何创建远程文件夹并为报文指派文件夹的方法。

* IMAP 协议为用户提供了创建文件夹以及将邮件从一个文件夹移动到另一个文件夹的命令。
* IMAP 为用户提供了在远程文件夹中查询邮件的命令，按指定条件去查询匹配的邮件。
* IMAP 服务器维护了 IMAP 会话的用户状态信息（与 POP3 不同）（文件夹的名字以及哪些报文与哪些文件夹相关联）。
* IMAP 具有允许用户代理获取报文某些部分的命令。



**基于 Web 的电子邮件**

用户代理为普通的浏览器，用户与远程邮箱使用 **HTTP** 进行通信。

邮件服务器之间仍使用 SMTP。



### DNS：因特网的目录服务

主机的标识方法：

* 主机名（www.facebook.com）
* IP 地址（121.7.106.83）



域名系统（Domain Name System，DNS）的主要任务：进行主机名到 IP 地址转换的目录服务。

**DNS**

* 一个由分层的 DNS 服务器实现的分布式数据库
* 一个使主机能够查询分布式数据库的应用协议

DNS 服务器通常是运行 BIND 软件的 UNIX 机器。

DNS 协议运行在 UDP 之上，使用 53 号端口。



DNS 的其他重要服务：

* 主机别名，规范主机名（canonical hostname )（relay1.west-coast.enterprise.com）
* 邮件服务器别名
* 负载分配



在 UNIX 上，利用函数 gethostbyname() 将主机名转换为 IP 地址



只使用一台 DNS 的问题

* 单点故障
* 通信容量
* 远距离集中式数据库
* 维护



DNS 服务器的类型

* 根 DNS 服务器：根名字服务器提供 TLD 服务器的 IP 地址。
* 顶级域（DNS）服务器：TLD 服务器提供了权威 DNS 服务器的 IP 地址。
* 权威 DNS 服务器

本地 DNS 服务器



TLD 服务器通常只是知道中间的某个 DNS 服务器，该中间 DNS 服务器依次才能知道用于该主机的权威 DNS 服务器。



理论上，任何 DNS 查询既可以是迭代的也能是递归的。

实践中，查询通常从请求主机到本地 DNS 服务器的查询是递归的，其余的查询是迭代的。



DNS 缓存：本地 DNS 服务器也能够缓存 TLD 服务器的 IP 地址，从而绕过查询链中的根 DNS 服务器。在实际中，除了少数 DNS 查询以外，根服务器均被绕过了。



DNS 服务器资源记录（Resource Record, RR）

```
(Name, Value, Type, TTL)	//TTL为该记录的生存时间
```

* Type = A，Name 为主机名，Value 为该主机名对应的 IP 地址。
* Type = NS，Name 是个域，Value 是个知道如何获得该域中主机 IP 地址的权威 DNS 服务器的主机名。
* Type = CHAME，Value 是别名为 Name 的**主机**对应的规范主机名。
* Type = MX，Value 是个别名为 Name 的**邮件服务器**的规范主机名，通过使用 MX 记录，一个公司的邮件服务器和其他服务器可以使用相同的别名。



如果一台 DNS 服务器是用于某特定主机名的权威 DNS 服务器，那么该 DNS 服务器会有一条包含用于该主机名的类型 A 记录。

如果服务器不是用于某主机名的权威服务器，那么该服务器将包含一条类型 NS 记录，该记录对应于包含主机名的域；它还将包括一条类型 A 记录，该记录提供了在 NS 记录的 Value 字段中的 DNS 服务器的 IP 地址。



**可以使用 nslookup 程序查询 DNS**



### 套接字编程：生成网络应用

网络应用程序

* 由协议中所定义的操作的实现
* 由客户和服务器程序应用的应用层协议没有公开发布在某 RFC 中或其他地方（专用的网络应用程序）



使用 UDP 的时候，必须先将目的地址附在数据分组之上，该目的地址是由目的主机的 IP 地址和目的地套接字的端口号组成。



## 运输层

运输层协议为运行在不同主机上的**应用进程**之间提供了逻辑通信（logic communication）功能。

运输层协议是在端系统中而不是在路由器中实现。

网络路由器仅作用于该数据报的网络层字段，即它们不检查封装在该数据报的运输层报文段的字段。

运输层协议只作用在端系统中。

运输层协议能过提供的服务常常受制于底层网络层协议的服务模型，但是即使底层网络协议不能在网络层提供相应的服务，运输层协议也能提供某些服务。

IP 不确保报文段的交付，不保证报文段的按序交付，不保证报文段中数据的完整性。

**将运输层的分组称为报文段**



UDP 与 TCP 提供的服务

* 将两个端系统间 IP 的交付服务扩展为运行在端系统上的两个进程之间的交付服务，称为**运输层的多路复用**和**多路分解**。
* 通过在报文段首部中包括差错检查字段而提供完整性服务。



### 多路复用与多路分解

多路复用与多路分解服务是所有计算机网络都需要的。

在接收主机中的运输层实际上并没有直接将数据交付给进程，而是将数据交给了一个中间的套接字。



**多路分解：**将运输层报文段中的数据交付到正确的套接字的工作。

**多路复用：**在源主机中从不同的套接字收集数据块，并为每个数据块封装上首部信息从而生成报文段，然后将报文段传递到网络层。

多路复用的要求：

* 套接字有唯一的标识符
* 每个报文段有特殊字段（源端口号字段、目的端口号字段）来指示报文段所要交付到的套接字。

UDP 套接字：由一个二元组（目的 IP 地址、目的端口号）全面标识。

TCP 套接字：由一个四元组（源 IP 地址、源端口号、目的 IP 地址、目的端口号）标识。



如果两个 UDP 报文段有不同的源 IP 地址 / 源端口号，但具有相同的目的 IP 地址和目的端口号，那么这两个报文段将通过相同的目的套接字被**定向到相同的目的进程**。

两个具有不同源 IP 地址或源端口号的到达 TCP 报文段将被**定向到两个不同的套接字**，除非 TCP 报文段携带了初始创建连接的请求。

连接套接字与进程之间并非总是有着一一对应的关系。



### 无连接传输：UDP

UDP 除了复用 / 分解功能以及少量的差错检测外，几乎没有对 IP 增加别的东西。

无连接的：在发送报文段之前，发送方和接收方的运输层实体之间没有握手。



DNS 使用 UDP：如果查询主机的 DNS 应用程序没有收到响应，要么向另一个名字服务器发送该查询，要么通知调用的应用程序它不能获得响应。



**使用 UDP 的原因**

* 关于发送什么数据以及何时发送的应用层控制更为精细，TCP 有一个拥塞控制机制。
* 无需建立连接，所以不会引入建立连接的时延，TCP 在开始传输数据之前要经过三次握手。
* 无连接状态，可以支持更多的活跃客户，TCP 需要在端系统中维护连接状态（接收和发送缓存、拥塞控制参数、序号与确认号的参数）
* 分组首部开销小，每个 TCP 报文段都有 20 字节的首部开销，而 UDP 仅有 8 字节的开销。



UDP 中缺乏拥塞控制会导致 UDP 发送方和接收方之间的高丢包率，并挤垮了 TCP 会话。



UDP 报文段结构包括源端口号、目的端口号、长度、检验和、应用数据。

应用层数据占用 UDP 报文段的数据字段。



UDP 可以提供差错检测，但是对差错恢复无能为力。

UDP 可以丢弃受损的报文段，或将受损的报文段交给应用程序并给出警告。





### 面向连接的运输：TCP

两个进程在互相发送报文之前必须先握手，即它们必须相互发送某些预备文段，以建立确保数据传输的参数。

TCP “连接”是一条逻辑连接，其共同状态仅保留在两个通信端系统的 TCP 程序中，中间的网络元素不会维持 TCP 连接状态。



三次握手：

* 客户先发送一个特殊的 TCP 报文段，该报文段中不包含应用层数据。
* 服务器用另一个特殊的 TCP 报文段响应。
* 客户再用第三个特殊的报文段响应。

前两个报文段不承载有效载荷，即不包含应用层数据，第三个报文段可以承载有效负荷。



**TCP 连接**

* 在报文段首部中的一个标志位（即 SYN 比特）被置为1，被称为 SYN 报文段，用户随机选择一个初始序号（client_isn），并将此编号放置于该起始的 TCP SYN 报文段的序号字段中。
* 服务器为该 TCP 连接分配 TCP 缓存和变量，并向该客户 TCP 发送允许连接的报文段（**SYNACK 报文段**），在允许连接的报文段的首部包含三个重要信息，SYN 比特被置为1，TCP 报文段首部的确认号字段被置为 client_isn + 1，服务器选择自己的初始序号（server_isn），并将其放置到 TCP 报文段首部的序号字段中。
* 在收到 SYNACK 报文段后，客户给该连接分配缓存和变量，并发送报文段对服务器允许连接的报文段进行确认（通过将值 server_isn + 1 放置到 TCP 报文首部的确认字段中来完成）因为连接已经建立，所以 SYN 比特被置为 0.



**TCP 关闭连接**

* 客户向服务器发送一个特殊的 TCP 报文段，报文段让其首部的一个标志位即 FIN 比特被置为 1。
* 服务器发送一个确认报文段。
* 服务器发送自己的终止报文段，其 FIN 比特被置为 1。
* 客户对服务器的终止报文段进行确认。



TCP 连接的组成：一台主机上的缓存、变量与进程连接的套接字、另一台主机上的另一组缓存、变量与进程连接的套接字。

TCP 可以从缓存中取出并放入报文段中的数据数量受限于**最大报文段长度**（Maximum Segment Size，MSS）

MSS 通常根据最初确定的由本地发送主机发送的最大链路层帧长度（即最大传输单元（Maximum Transmission Unit，MTU））设置。

设置 MSS 要保证一个 TCP 报文段（当封装在一个 IP 数据报中）加上 TCP/IP 首部长度（通常40字节）将适合耽搁链路层帧。

MSS 指在报文段里应用层数据的最大长度，而不是指包括首部的 TCP 报文段的最大长度。



TCP 可靠传输的关键部分：序号字段、确认号字段

序号是建立在传送的字节流之上，而不是建立在传送的报文段的序列之上，所以**报文段的序号**是该报文段首字节的字节流编号。

确认号：主机正在等待的数据的下一个字节序号。

累计确认：TCP 只确认该流中至第一个丢失字节为止的字节。



TCP 没有明确规定如何处理失序的报文段：

* 接收方立即丢弃失序报文段（可以简化接收方的设计）。
* 接收方保留失序的字节，并等待缺少的字节以填充该间隔。



TCP 连接的双方均可以随机地选择初始序号，这样可以减少将那些仍在网络中存在的来自两台主机之间先前已终止的连接的报文段，误认为是后来这两台主机之间新建连接所产生的有效报文段的可能性。



报文段里没有数据仍有序号：因为 TCP 存在序号字段，报文段需要填入某个序号。



**估计往返时间**

大多数 TCP 的实现仅在某个时刻做一次 SampleRTT 测量，而不是为每个发送的报文段测量一个 SampleRTT。

TCP 决不为已被重传的报文段计算 SampleRTT；它仅为传输一次的报文段测量 SampleRTT。



流量控制服务：消除发送方使接收方缓存溢出的可能性，即发送方的发送速率与接收方应用程序的读取速率相匹配。

通过让发送方维护一个接收窗口的变量来实现流量控制，接收窗口为空闲空间的大小。



网络阻塞的代价：

* 当分组的到达速率接近链路容量时，分组经历巨大的排队时延。
* 发送方必须执行重传以补偿因为缓存溢出而丢弃的分组。
* 发送方在遇到大时延时所进行的不必要重传会引起路由器利用其链路带宽来转发不必要的分组副本。
* 当一个分组沿一条路径被丢弃时，每个上游路由器用于转发该分组到丢弃该分组而使用的传输容量最终被浪费掉了。



**TCP 拥塞控制**

让每一个发送方根据所感知到的网络拥塞程度来限制其能向连接发送流量的速率。



拥塞窗口：对一个 TCP 发送方能向网络中发送流量的速率进行了限制。



如何判断拥塞：

* 一个丢失的报文段表意味着拥塞，因此当丢失报文段时应当降低 TCP 发送方的速率。
* 一个确认报文段指示该网络正在向接收方交付发送方的报文段，因此，当对先前未确认报文段的确认到达时，能够增加发送方的速率。
* 带宽探测，TCP 发送方增加它的传输速率，从该速率后退，进而再次开始探测，看看拥塞开始速率是否发生了变化。



拥塞控制算法：慢启动、拥塞避免、快速恢复

慢启动和拥塞避免是 TCP 的强制部分，两者的差异在于对收到的 ACK 做出反应时增加 cwnd 长度的方式。慢启动比拥塞避免能更快地增加 cwnd 长度。

快速恢复是推荐部分，对 TCP 发送方并非是必须的。



**慢启动**

在慢启动状态，cwnd 的值以一个 MSS 开始并且每当传输的报文段首次被确认就增加一个 MSS（一倍），TCP 发送速率起始慢，但在慢启动阶段以指数增长。

何时结束指数增长？

* 如果存在一个由超时指示的丢包事件（即拥塞），TCP 发送方将 cwnd 设置为 1 并重新开始慢启动过程，并将第二个状态变量的值 ssthresh（慢启动阈值）设置为 cwnd/2，即当检测到拥塞时将 ssthresh 置为拥塞窗口值的一半。
* 当 cwnd 的值等于 ssthresh 时，结束慢启动并且 TCP 转移到拥塞避免模式。
* 如果检测到 3 个冗余 ACK，这时 TCP 执行一种快速重传并进入快速恢复状态。



**拥塞避免**

每个 RTT 只将 cwnd 的值增加一个 MSS。

通用方法：对于 TCP 发送方无论何时到达一个新的确认，就将 cwnd 增加一个 MSS(MSS/cwnd) 字节。

何时结束线性增长？

当出现超时时，与慢启动的情况一样，cwnd 的值被设置为 1 个 MSS；

当丢包事件出现时，ssthresh 的值被更新为 cwnd 值的一半。



如果是由三个冗余 ACK 触发的丢包事件，网络继续从发送方向接收方交付报文段，TCP 将 cwnd 的值减半，并且当收到 3 个冗余的 ACK，将 ssthresh 的值记录为 cwnd 的值的一半，接下来进入快速恢复状态。



**快速恢复**

在快速恢复中，对于引起 TCP 进入快速恢复状态的缺失报文段，对收到的每个冗余的 ACK，cwnd 的值增加一个 MSS。



当 TCP 连接的路径上判断不拥塞时，其传输速率就加性增；当出现丢包时，传输速率就乘性减。





## 网络层：数据平面

数据平面：网络层中每台路由器的功能。

控制平面：网络范围的逻辑。

转发：将分组从一个输入链路接口转移到适当的输出链路接口的路由器本地动作。

路由选择：确定分组从源到目的地所采取的端到端路径的网络范围处理过程。

路由器具有截断的协议栈，没有网络层以上的部分。



网络服务模型：定义了分组在发送与接收端之间的端到端运输特性。

网络层可能提供的服务：

* 确保交付
* 具有时延上界的延时交付
* 有序分组交付
* 确保最小带宽
* 安全性

因特网的网络层提供的服务：**尽力而为服务**



链路层交换机：基于链路层帧中的字段值做出转发决定（**链路层设备**）

路由器：基于网络层数据报中的首部字段做出转发决定（**网络层设备**）



### 路由器的工作原理

**输入接口：**在路由器中执行终结如物理链路的物理层功能；与位于入链路远端的数据链路层交互来执行数据链路层功能；在输入与输出端口执行查找功能。

**交换结构：**将路由器的输入端口连接到它的输出端口，是一个网络路由器中的网络。

**输出端口：**存储从交换结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组，如果一条链路是双向的，输出端口通常与该链路的输入端口成对出现在同一条线路卡上。

**路由选择协议：**执行控制平面功能，在传统的路由器中，执行路由选择协议，维护路由选择表与关联链路状态信息，并为该路由器计算转发表。在 SDN 路由器中，路由选择处理器负责与远程控制器通信，目的是接收由远程控制器计算的转发表项，并在路由器的输入端口安装这些表项；还执行网络管理的功能。



在输入端口处理中的查找必须采取的其他动作

* 必须出现物理层和链路层的处理。
* 必须检查分组的版本号、检验以及寿命字段，并且重写后两个字段。
* 必须更新用于网络管理的计数器。



交换的类型：

* 经内存交换：不能同时转发两个分组，经过共享系统总线一次仅能执行一个内存读 / 写。
* 经总线交换：一次只有一个分组可以跨越总线。
* 经互联网络交换：能够并行转发多个分组。纵横式交换机是非阻塞的，即只要没有其他分组当前被转发到该输出端口，转发到输出端口的分组将不会被到达输出端口的分组阻塞。



一个 IP 地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联。

一个接口的 IP 地址的一部分需要由其连接的子网来决定。





## 网络层：控制平面

控制平面不仅控制沿着从源主机到目的主机的端到端路径间的路由如何转发数据报，而且控制网络层组件和服务如何配置和管理。



### 路由选择算法

目的是从发送方到接收方的过程中确定一条通过路由器网络的好的路径。



**路由选择算法的分类**

* 根据该算法式集中式还是分散式划分

**集中式路由选择算法：**用完整的、全局性的网络知识计算出从源到目的地之间的最低开销路径。

**分散式路由选择算法：**路由器以迭代、分布式的方式计算出最低开销路径。

具有全局状态信息的算法常被称作**链路状态（Link State，LS）算法**，因为该算法必须知道网络中每条链路的开销。

* 根据算法式静态的还是动态的划分

**静态路由选择算法：**路由随时间变化非常缓慢，通常是人工进行调整。

**动态路由选择算法：**随着网络流量负载或拓扑发生变化而改变路由选择路径。

* 根据是负载敏感还是负载迟顿进行划分

**负载敏感算法：**链路开销会动态地变化以反映底层链路的当前拥塞水平。

**负载迟顿算法：**某条链路的开销不明确地反映当前的拥塞水平。



链路状态路由选择算法（LS算法）

通过让每个节点向网络中所有其他节点广播链路状态分组来完成，其中每个链路状态分组包含它所连接的链路的标识和开销。

Dijkstra算法：计算从某节点到网络中所有其他节点的最低开销路径，**迭代算法**。

LS 算法会引发震荡，如何防止震荡？

* 强制链路开销不依赖于所承载的流量
* 确保并非所有的路由器都同时运行 LS 算法





## 链路层和局域网

广播信道，用于连接有限局域网、卫星网和混合光纤同轴电缆接入网中的多台主机。

点对点通信链路，长距离连接的两台主机之间，用户办公室计算机与它们所连接的临近以太网交换机之间。

在通过特定的链路时，传输节点将数据报封装在**链路层帧**中，并将该帧传送到链路中。



链路层协议能够提供的可能服务

* 成帧，一个帧由一个数据字段和若干首部字段组成，其中网络层数据报就插在数据字段中。
* 链路接入
* 可靠交付，通常是通过确认和重传取得的，通常用于易产生高差错率的链路，目的是本地（在差错发生的链路上）纠正一个差错，而不是通过运输层或应用层协议迫使进行端到端的数据重传。
* 差错检测和纠正，接收方不仅可以检测帧中出现的比特差错，而且能够准确地确定帧中的差错出现的位置，并因此纠正这些差错。



在传输数据中检测差错的三种技术：奇偶校验、检验和方法、循环冗余检测



多路访问协议划分为：信道划分协议、随机接入协议、轮流协议



时分多路复用缺点：

* 节点被限制于 R/N bps 的平均速率，即使当它是唯一有分组要发送的节点时
* 节点必须总是等待它在传输序列中的轮次，即使它是唯一一个有帧要发送的节点

频分多路复用

优点：避免了碰撞，在 N 个节点之间公平地划分了带宽

缺点：限制一个节点只能使用 R/N 的带宽，即使当它是唯一一个有分组要发送的节点时



**随机接入协议**

一个传输节点总是以信道的全部速率进行发送。

当有碰撞时，涉及碰撞的每个节点反复地重发它的帧，到该帧无碰撞地通过为止，它在重发该帧之前等待一个随机时延，随机时延是独立选择的。



**地址解析协议（ARP）**

转换网络层地址和链路层地址

DNS 为在因特网中任何地方的主机解析主机名，而 ARP 只为在**同一个子网**上的主机和路由器接口解析 IP 地址。

查询 ARP 报文是在广播帧中发送的，而响应 ARP 报文是在一个标准帧中发送。

ARP 是即插即用的，一个 ARP 表是自动建立的，不需要系统管理员来配置，如果某主机与子网断开连接，它的表项最终会从留在子网中的节点的表中删除。



以太网帧结构：

* 数据字段（46 ～ 1500 字节）
* 目的地址（6 字节）
* 源地址（6 字节）
* 类型字段（2 字节）
* CRC（4 字节）
* 前同步码（8 字节）

以太网技术向网络层提供不可靠服务，当接受到帧时，如果该帧通过了 CRC 校验，不发送确认帧，如果该帧没有通过 CRC 校验时也不发送否定确认帧，而是丢弃该帧。









